<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #444;
            margin-bottom: 10px;
        }

        .label {
            font-weight: bold;
            color: #666;
        }

        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Weather Forecast</h1>
    <h2>Your Location Weather and Tonight's Forecast</h2>

    <div class="container" id="info">
        <p><span class="label">Current Location:</span></p>
        <p id="location">Loading...</p>

        <p><span class="label">Current Weather:</span></p>
        <p id="current-weather">Loading...</p>

        <p><span class="label">Tonight's Forecast:</span></p>
        <p id="tonight-forecast">Loading...</p>
    </div>

    <script>
        const locationElement = document.getElementById("location");
        const currentWeatherElement = document.getElementById("current-weather");
        const tonightForecastElement = document.getElementById("tonight-forecast");

        async function fetchWeatherDetails() {
            try {
                // Step 1: Fetch user's location and ISP details using IP
                const ipResponse = await fetch('https://ipapi.co/json/');
                if (!ipResponse.ok) throw new Error("Failed to fetch location details.");
                const ipData = await ipResponse.json();

                const city = ipData.city;
                const country = ipData.country_name;
                locationElement.textContent = `${city}, ${country}`;

                // Step 2: Fetch current weather and tonight's forecast
                const apiKey = "524a4e7dd19165afe1880c716e00b368"; // Replace with your OpenWeatherMap API key
                const weatherUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city},${country}&units=metric&appid=${apiKey}`;
                const weatherResponse = await fetch(weatherUrl);
                if (!weatherResponse.ok) throw new Error("Failed to fetch weather data.");
                const weatherData = await weatherResponse.json();

                // Step 3: Extract current weather
                const currentWeather = weatherData.list[0];
                currentWeatherElement.textContent = `${currentWeather.weather[0].description}, ${currentWeather.main.temp}°C`;

                // Step 4: Extract tonight's forecast (typically around 9:00 PM)
                const tonightForecast = weatherData.list.find(item => {
                    const forecastTime = new Date(item.dt * 1000).getHours();
                    return forecastTime === 21; // 21:00 = 9:00 PM
                });

                if (tonightForecast) {
                    tonightForecastElement.textContent = `${tonightForecast.weather[0].description}, ${tonightForecast.main.temp}°C`;
                } else {
                    tonightForecastElement.textContent = "Forecast for tonight is unavailable.";
                }
            } catch (error) {
                console.error("Error fetching weather details:", error);
                locationElement.textContent = "Error loading location.";
                currentWeatherElement.textContent = "Error loading current weather.";
                tonightForecastElement.textContent = "Error loading tonight's forecast.";
            }
        }

        fetchWeatherDetails();
    </script>
</body>
</html>
